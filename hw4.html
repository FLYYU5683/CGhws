<!DOCTYPE html>
<html>
<body>
<div id="info">Candle Light Animation
  <br>
<button id='toggle'>Toggle</button>
</div>
<style>
#info {
	position: absolute;
	top: 20px;
	width: 100%;
	text-align: center;
	color: #ffff00;
}
body {
  overflow: hidden;
  margin:0;
	padding:0;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script type = "module">
import * as THREE from "https://threejs.org/build/three.module.js";
import { OrbitControls } from "https://threejs.org/examples/jsm/controls/OrbitControls.js";

$('#toggle').click(function() {
	flameOff = !flameOff;
  if (flameOff) {
  	clearInterval (flameInterval);
    flameMesh.material.visible = false;
  } else {
   	flameInterval = setInterval (textureAnimate, 100);
    flameMesh.material.visible = true;
  }
});

var camera, scene, renderer;
var flameMesh;
var candle;
var flameOff = false;
var flameInterval;
var candles = [];

class Candle{
  constructor(px){
    console.log("1");
    this.candle = new THREE.Group();
    this.body = new THREE.Mesh (new THREE.CylinderGeometry(5,5,20,60), new THREE.MeshNormalMaterial());
    this.candle.add (this.body);
    this.body.position.y = 10;
	var loader = new THREE.TextureLoader();
    // load a resource
    loader.load(
    // URL ...
    'https://i.imgur.com/M2tr5Tm.png?1',
    // onLoad ...
    function(texture) {
      // do something with the texture
      // Plane with default texture coordinates [0,1]x[0,1]
      var texMat = new THREE.MeshBasicMaterial({
        map: texture,
        alphaTest:0.5
      });
      this.flameMesh = new THREE.Mesh(new THREE.PlaneGeometry(30,30), texMat);
      texture.wrapS = THREE.RepeatWrapping;
      texture.wrapT = THREE.RepeatWrapping;
      texture.repeat.set (1/3,1/3);
      texture.offset.set (0,2/3);
      //scene.add (flameMesh);
      this.candle.add (this.flameMesh);
	  
      scene.add (this.candle);
	  this.candle.x = px;
      this.flameMesh.position.y = 28;
      
    },
		undefined, // onProgress
    // onError ...
    function(xhr) {
      console.log('An error happened');
    }
  );
  };

};
init();
animate();
function init() {
  renderer = new THREE.WebGLRenderer({
    antialias: true
  });
	renderer.setClearColor (0x888888);
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(50, 1, 1, 10000);
  camera.position.z = 100;

  let controls = new OrbitControls(camera, renderer.domElement);
 	scene.add (new THREE.GridHelper(200,20,'red','white'));
  ////////////////////////////////////////////////////////////
  for(var k = 0;k < 10; k++){
    candles.push(new Candle(k * 10));
  }
  window.addEventListener('resize', onWindowResize, false);
  
  flameInterval = setInterval (textureAnimate, 100);
}

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function textureAnimate() {
  textureAnimate.count = (textureAnimate.count === undefined) ? 1 : textureAnimate.count;

  //console.log (textureAnimate.count)
  if (flameMesh!== undefined) {
    var texture = flameMesh.material.map;
    //console.log (`${textureAnimate.count}: [${texture.offset.x},${texture.offset.y}]`);
    texture.offset.x += 1/3;
 
 		if (textureAnimate.count % 3 === 0) {
    	texture.offset.y -= 1/3;
    }
    textureAnimate.count++;
  }
}

function animate() {
  requestAnimationFrame(animate);
  render();
  
  // billboard
  // candle.lookAt (camera.position)  // does not work
  candle.lookAt(camera.position.x, 0, camera.position.z);
  
}

function render() {
  renderer.render(scene, camera);
}


</script>
</body>
</html>